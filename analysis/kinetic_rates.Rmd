---
title: "CANDO+P Reactor Kinetic Rates"
---
This notebook produces calculated kinetic rate values and plots for CANDO+P in-cycle sampling data.

## Code set up
```{r setup}
# packages
library(readxl)
library(tidyverse)
library(zoo)
library(reshape2)
library(purrr)

```

## Data import - cycle data
```{r message=FALSE, warning=FALSE}
# import
setwd("C:/Users/mckyf/Box/CANDO+P and N2O/CANDO+P Reactor 2021/Operation and Logs/Performance logs")
sheet_name = "master"
in_skalar <- "cycle_results.xlsx"
cycle_skalar <- read_excel(in_skalar, sheet=sheet_name)
```

## Cleaning
```{r message=FALSE, warning=FALSE}
cycle_skalar <- cycle_skalar %>% select(-c(date_time))

start_time <- as.POSIXct("1899-12-31 08:22:00", tz="GMT")

# time value
cycle_skalar$time_diff <- as.numeric(difftime(cycle_skalar$time, start_time, units="hours"))

# split by nutrient - we have to do this because some nutrients have NA values differentially between dates, this doesn't mesh with the lm function
df_op <- cycle_skalar %>%                                         # Apply filter & is.na
  filter(!is.na(OP_mgPL))
df_no2 <- cycle_skalar %>%                                         # Apply filter & is.na
  filter(!is.na(NO2_mgNL))


# split data by phase and date, drop empty dataframes
split_op <- split(df_op,list(df_op$phase,df_op$date), drop=TRUE)
split_no2 <- split(df_no2,list(df_no2$phase,df_no2$date), drop=TRUE)
```

## Estimating rate for each date and phase
Note - In this script, I am estimating the bulk rate over time for the entire phase. I'm not looking at max rate or subsetting the phase at all.
Entire code from this stackoverflow response :,)
https://stackoverflow.com/questions/49043166/r-how-do-you-loop-an-linear-model-over-a-list-of-data-frames
```{r}
# OP rates
lms_op <- lapply(split_op, function(a) coef(lm(OP_mgPL~time_diff, data=a)))
rates_op <- do.call(rbind, lms_op)


# NO2 rates
lms_no2 <- lapply(split_no2, function(a) coef(lm(NO2_mgNL~time_diff, data=a)))
rates_no2 <- do.call(rbind, lms_no2)

```

## Save csvs
```{r}
setwd("C:/Users/mckyf/Box/CANDO+P and N2O/CANDO+P Reactor 2021/Operation and Logs/Performance logs")
write.csv(rates_op, "rates_op.csv")
write.csv(rates_no2, "rates_no2.csv")
```

